var LessCompiler,Stor;Stor=function(){function Stor(key,exp){this.key=null!=key?key:void 0,this.exp=null!=exp?exp:null,this.amp=amplify.store}return Stor.prototype.get=function(key){return null==key&&(key=this.key),this.amp(key)},Stor.prototype.set=function(val,key,exp){return null==key&&(key=this.key),null==exp&&(exp=this.exp),this.amp(key,val,exp)},Stor.prototype.remove=function(key){return null==key&&(key=this.key),this.amp(key,null)},Stor.prototype.empty=function(){var self,storage;return self=this,storage=self.amp(),$.each(storage,function(itm,key){self.amp(key,null)})},Stor}(),LessCompiler=function(){function LessCompiler(elements,options){var defaults;elements&&(this.elements=elements,this.editor=CodeMirror.fromTextArea(elements.lessInput[0],{theme:"lesser-dark",lineNumbers:!0,matchBrackets:!0,tabSize:2}),defaults={cdnFallback:"js/less/less-{version}.js",useFallback:!1,saveLess:!0,lessCDN:"//raw.github.com/cloudhead/less.js/master/dist/less-{version}.js"},this.options=$.extend(defaults,options),this.storage=new Stor("lessCode"))}return LessCompiler.prototype.setupEvents=function(){var cachedLess,editor,els,self,versionOpts;return self=this,els=this.elements,editor=this.editor,cachedLess=this.storage.get(),versionOpts=els.lessVersion.find("option"),cachedLess?(editor.setValue(cachedLess),this.previousLessCode=cachedLess):this.previousLessCode=editor.getValue(),els.lessVersion.on("change",function(){var preRelease;return preRelease=versionOpts.filter(":selected").is("[data-prerelease=true]")?!0:!1,self.loadLess(preRelease)}),editor.on("change",function(){var lessCode;lessCode=self.editor.getValue(),self.previousLessCode!==lessCode&&(self.previousLessCode=lessCode,self.compileLess())}),this},LessCompiler.prototype.loadLess=function(preRelease){var els,getScript,opts,path,scriptUrl,self,version;return self=this,opts=this.options,els=this.elements,path=opts.useFallback?opts.cdnFallback:opts.lessCDN,els.loadingGif.fadeIn(),this.editor.options.readOnly=!0,version=els.lessVersion.val(),version=preRelease?""+version+"-alpha":version,scriptUrl=path.replace("{version}",version),window.less=void 0,getScript=$.ajax({dataType:"script",cache:!0,url:scriptUrl}),getScript.then(function(){window.less?self.loadComplete.call(self):(self.tryCount=self.tryCount?self.tryCount++:1,self.options.useFallback=!0,3>=self.tryCount&&self.loadLess())}),this},LessCompiler.prototype.loadComplete=function(){return this.parser=new less.Parser({}),this.editor.options.readOnly=!1,this.compileLess(),this.elements.loadingGif.fadeOut(),this},LessCompiler.prototype.compileLess=function(){var compiledCSS,lessCode;lessCode=this.editor.getValue(),this.options.saveLess&&this.storage.set(lessCode);try{compiledCSS=this.parseLess(lessCode),this.updateCSS(compiledCSS)}catch(lessEx){this.updateError(lessEx)}return this},LessCompiler.prototype.updateCSS=function(compiledCSS){var highlightedCSS;return highlightedCSS=hljs.highlight("css",compiledCSS).value,this.elements.cssCode.css("color","").html(highlightedCSS),this},LessCompiler.prototype.updateError=function(lessEx){var errorText;return errorText=""+lessEx.type+" error: "+lessEx.message+"\n"+(lessEx.extract&&lessEx.extract.join&&lessEx.extract.join("")),this.elements.cssCode.css("color","red").text(errorText),this},LessCompiler.prototype.parseLess=function(lessCode){var resultCss;return resultCss="",this.parser.parse(lessCode,function(lessEx,result){if(lessEx)throw lessEx;return resultCss=result.toCSS()}),resultCss},LessCompiler}(),jQuery(function($){var compiler,elements;return elements={lessVersion:$("#lessVersion"),loadingGif:$("#loadingGif"),lessInput:$("#lessInput"),cssCode:$("#cssOutput")},compiler=window.comp=new LessCompiler(elements),compiler.setupEvents().loadLess()});